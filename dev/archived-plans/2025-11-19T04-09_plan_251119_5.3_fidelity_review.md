# Remediation Plan: Architectural Fidelity

**Date:** 2025-11-19
**Task Reference:** 5.3 from ./dev/tasks.md
**Status:** Ready for Implementation

## Plan Overview

This plan addresses architectural compliance issues in Task 5.3 (Symbolic link management). Implementation introduces LinkManager service and integrates it into TranscriptService, fulfilling FR-4 (Link Distribution) and TR-9 (Link Creation) specifications. The changes establish proper separation of concerns by extracting link management logic into dedicated service layer, ensuring TranscriptService maintains focus on orchestration while LinkManager handles cross-platform symbolic link operations, registry tracking, and cleanup.

## Tasks Planned

- 5.3 Symbolic link management (implements FR-4, TR-9)
  - 5.3.1 Implement symbolic link creation
  - 5.3.2 Add link tracking in registry
  - 5.3.3 Handle existing link overwrites
  - 5.3.4 Add cross-platform link compatibility

## High-Level Steps
1. Complete TranscriptService Integration
2. Implement Video Processing Orchestration
3. Validate Registry Schema Compliance
4. Verify Cross-Platform Compatibility

## Detailed Breakdown

### Step 1: Complete TranscriptService Integration

#### A. Rationale & Objective
TranscriptService.processVideo() method introduced but lacks complete integration with workflow orchestration (FR-2.3, TR-7). Method accepts project directory but doesn't validate or handle edge cases per requirements.

#### B. Recommended Approach & Strategy
TranscriptService must orchestrate full video processing workflow: cache check (FR-2.2), transcript fetch (FR-2.1), persistence (FR-2.3), link creation (FR-4), and registry update (FR-3.2). Current implementation delegates to LinkManager but doesn't implement sequential processing loop or batch URL handling.

#### C. Implementation Guidelines

```javascript
// src/services/TranscriptService.js

/**
 * Process multiple video URLs from input file
 * Implements FR-1.1, FR-2.3, TR-7 complete workflow
 *
 * @param {string[]} videoUrls - Array of YouTube URLs
 * @param {string} projectDir - Target directory for links
 * @returns {Promise<Object>} Batch results with success/failure counts
 */
async processBatch(videoUrls, projectDir = process.cwd()) {
  const results = {
    processed: 0,
    cached: 0,
    fetched: 0,
    linked: 0,
    failed: 0,
    errors: []
  };

  // Sequential processing per BR-2
  for (const url of videoUrls) {
    try {
      const videoId = this.extractVideoId(url);
      const result = await this.processVideo(videoId, url, projectDir);

      results.processed++;
      if (result.cached) results.cached++;
      else results.fetched++;
      if (result.linked) results.linked++;

    } catch (error) {
      results.failed++;
      results.errors.push({ url, error: error.message });
      // Continue per FR-10.1
      console.error(`[Process] Failed ${url}: ${error.message}`);
    }
  }

  return results;
}
```

Add URL extraction method implementing TR-5 regex pattern.

### Step 2: Implement Video Processing Orchestration

#### A. Rationale & Objective
Current processVideo() implementation incomplete - missing cache-first strategy validation and atomic operation requirements (FR-9.1). Method must ensure transcript persists before link creation per crash-resilient design (FR-2.3).

#### B. Recommended Approach & Strategy
Refactor processVideo() to explicitly verify cache-first workflow, validate transcript persistence occurred, and handle partial failures gracefully. Registry updates must occur atomically after each successful fetch per FR-9.1.

#### C. Implementation Guidelines

```javascript
async processVideo(videoId, videoUrl, projectDir = process.cwd()) {
  validators.assertValidVideoId(videoId);
  const absoluteProjectDir = path.resolve(projectDir);

  // Step 1: Cache check (FR-2.2, BR-1)
  const cached = await this.checkCache(videoId);

  let transcript;
  if (cached) {
    transcript = await this.storage.readTranscript(videoId);
    console.log(`[Cache] Hit: ${videoId}`);
    this.stats.cacheHits++;
  } else {
    // Step 2: Fetch from API (FR-2.1)
    transcript = await this.fetchTranscript(videoId, videoUrl);

    // Step 3: Persist immediately (FR-2.3, FR-9.1)
    await this.storage.saveTranscript(videoId, transcript);
    console.log(`[Fetch] Saved: ${videoId}`);
    this.stats.cacheMisses++;
  }

  // Step 4: Create link (FR-4)
  const linkResult = await this.linkManager.createLink(videoId, absoluteProjectDir);

  return {
    success: true,
    videoId,
    cached,
    linked: linkResult.success,
    linkPath: linkResult.path
  };
}
```

Validate each step completion before proceeding to next.

### Step 3: Validate Registry Schema Compliance

#### A. Rationale & Objective
LinkManager._trackLink() creates registry entries but doesn't validate schema compliance (FR-3.2). Registry structure must match exact specification: `{ "videoId": { "date_added": "YYYY-MM-DD", "links": [...] } }`.

#### B. Recommended Approach & Strategy
Validate registry entry structure matches FR-3.2 schema before persistence. Ensure date_added uses YYYY-MM-DD format per BR-4. Verify links array contains absolute paths per TR-9.

#### C. Implementation Guidelines

```javascript
// src/services/LinkManager.js

async _trackLink(videoId, linkPath) {
  const registry = await this.storage.loadRegistry();
  const absolutePath = path.resolve(linkPath);

  // Create entry matching FR-3.2 schema
  if (!registry[videoId]) {
    const dateAdded = new Date().toISOString().split('T')[0]; // YYYY-MM-DD per BR-4

    registry[videoId] = {
      date_added: dateAdded,  // FR-3.2 exact key name
      links: []
    };
  }

  // Validate existing entry structure
  if (!registry[videoId].date_added || !Array.isArray(registry[videoId].links)) {
    throw new Error(`Registry entry corrupted for ${videoId} - schema violation`);
  }

  // Idempotent link addition
  if (!registry[videoId].links.includes(absolutePath)) {
    registry[videoId].links.push(absolutePath);
    await this.storage.saveRegistry(registry);
  }
}
```

StorageService.isValidRegistryStructure() should validate date_added format matches YYYY-MM-DD.

### Step 4: Verify Cross-Platform Compatibility

#### A. Rationale & Objective
LinkManager handles Windows EPERM error but doesn't verify symbolic link support detection or graceful degradation on unsupported platforms (TR-9, FR-4.1.4).

#### B. Recommended Approach & Strategy
Detect platform capabilities during initialization. Provide clear error messages for Windows users without Developer Mode enabled. Verify fs-extra.ensureSymlink handles type parameter correctly across platforms.

#### C. Implementation Guidelines

```javascript
// src/services/LinkManager.js

async createLink(videoId, projectDir = process.cwd()) {
  // ... existing validation ...

  try {
    // fs-extra ensureSymlink handles platform differences
    await fs.ensureSymlink(sourcePath, targetPath, 'file');
    await this._trackLink(videoId, targetPath);

    return { success: true, path: targetPath, replaced: validation.status !== 'none' };

  } catch (error) {
    // Windows-specific guidance per TR-9 requirements
    if (error.code === 'EPERM' && process.platform === 'win32') {
      throw new Error(
        'Symbolic link creation requires elevated privileges on Windows.\n' +
        'Solutions:\n' +
        '1. Enable Developer Mode (Settings > Update & Security > For Developers)\n' +
        '2. Run terminal as Administrator\n' +
        'See: https://docs.microsoft.com/en-us/windows/apps/get-started/enable-your-device-for-development'
      );
    }

    // Platform-agnostic error
    throw new Error(`Symlink creation failed for ${videoId}: ${error.message}`);
  }
}
```

Test on Windows, macOS, and Linux to verify fs-extra compatibility.

## Validation Checklist

- [ ] TranscriptService.processVideo() implements complete TR-7 workflow
- [ ] processBatch() handles sequential processing per BR-2
- [ ] Cache-first strategy validated before API calls (BR-1)
- [ ] Registry entries match FR-3.2 exact schema
- [ ] date_added uses YYYY-MM-DD format per BR-4
- [ ] links array contains absolute paths only
- [ ] Cross-platform error messages clear and actionable
- [ ] Windows Developer Mode guidance provided
- [ ] fs-extra.ensureSymlink type parameter verified
- [ ] Atomic persistence after each fetch per FR-9.1
- [ ] No scope creep beyond Task 5.3 boundaries
