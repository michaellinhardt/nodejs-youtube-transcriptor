# Implementation Plan: 8.1 - File System Error Handling

**Date:** 2025-11-19
**Task:** 8.1 - File System Error Handling (implements TR-13)
**Status:** Ready for Implementation
**Requirements:** TR-13 (File System Errors), FR-10 (Failure Recovery)

## Plan Overview

Complete the file system error handling implementation by adding EINVAL (invalid path) error handling across all file operations. Currently, ENOENT, EACCES, and EEXIST are handled comprehensively, but EINVAL scenarios are not explicitly caught. This plan adds defensive error handling for invalid path scenarios, particularly important for cross-platform compatibility where path constraints differ (Windows vs Unix).

## Tasks Planned

- 8.1 File system error handling (implements TR-13)
  - 8.1.1 Handle ENOENT (create missing directories) [ALREADY IMPLEMENTED]
  - 8.1.2 Handle EACCES (permission errors) [ALREADY IMPLEMENTED]
  - 8.1.3 Handle EEXIST (overwrite scenarios) [ALREADY IMPLEMENTED]
  - 8.1.4 Handle EINVAL (invalid paths) [TO BE IMPLEMENTED]

## High-Level Steps

1. Add EINVAL handling to StorageService file operations
2. Add EINVAL handling to LinkManager symlink operations
3. Verify cross-platform path validation coverage
4. Test error messages provide actionable guidance

## Detailed Implementation

### Step 1: Add EINVAL Handling to StorageService

#### A. Rationale & Objective
StorageService performs file read/write operations that can fail with EINVAL when paths contain invalid characters or exceed platform limits. Currently, EINVAL errors fall through to generic error handlers. Need explicit handling to provide clear user feedback.

#### B. Core Concepts & Strategy
Add EINVAL detection to existing error handler methods:
- `_handleReadError()` - Add EINVAL case
- `_handleDeleteError()` - Add EINVAL case
- `atomicWriteJson()` error handling - Add EINVAL case

Follow existing error handling pattern: detect error code, provide descriptive message with context.

#### C. Implementation Guidelines

**Key Logic:**

```javascript
// In _handleReadError method (line ~356)
_handleReadError(error, videoId, operation) {
  if (error.code === 'ENOENT') {
    throw new Error(`Transcript not found: ${videoId}`);
  }

  if (error.code === 'EACCES' || error.code === 'EPERM') {
    throw new Error(`Permission denied ${operation} transcript ${videoId}`);
  }

  // NEW: Add EINVAL handling
  if (error.code === 'EINVAL') {
    throw new Error(
      `Invalid path for transcript ${videoId}. ` +
      'Path may contain unsupported characters or exceed length limits.'
    );
  }

  throw error;
}

// Similar pattern for _handleDeleteError (line ~397)
_handleDeleteError(error, videoId) {
  if (error.code === 'ENOENT') {
    return;
  }

  if (error.code === 'EISDIR' || error.code === 'EPERM') {
    throw new Error(`Cannot delete: path is not a file (${videoId})`);
  }

  if (error.code === 'EACCES') {
    throw new Error(`Permission denied deleting transcript ${videoId}`);
  }

  // NEW: Add EINVAL handling
  if (error.code === 'EINVAL') {
    throw new Error(
      `Invalid path for transcript ${videoId}. ` +
      'Path may contain unsupported characters or exceed length limits.'
    );
  }

  throw new Error(`Failed to delete transcript ${videoId}: ${error.message}`);
}
```

**Critical Points:**
- EINVAL typically occurs with null bytes in path, reserved names (Windows: CON, PRN, AUX), or paths exceeding MAX_PATH
- Error message should be actionable - explain likely causes
- Maintain consistency with existing error message patterns
- Don't catch EINVAL during validation (video ID regex prevents most issues)

#### D. Success Criteria
- [ ] EINVAL handling added to `_handleReadError()`
- [ ] EINVAL handling added to `_handleDeleteError()`
- [ ] EINVAL handling added to `_handleExistenceCheckError()`
- [ ] EINVAL handling added to atomic write error paths
- [ ] Error messages provide clear explanation of invalid path issue

#### E. Dependencies & Inputs
- Requires: StorageService.js (existing file)
- Produces: Enhanced error messages for invalid path scenarios

### Step 2: Add EINVAL Handling to LinkManager

#### A. Rationale & Objective
LinkManager creates symbolic links which can fail with EINVAL when target/source paths are invalid. Currently only EPERM (Windows privileges) and generic errors are caught. Need EINVAL handling for invalid path scenarios.

#### B. Core Concepts & Strategy
Add EINVAL detection in:
- `createLink()` method - After ensureSymlink call (line ~86)
- `validateTarget()` method - During path validation (line ~187)
- `removeLink()` method - During unlink operation (line ~296)

EINVAL in symlink context typically means:
- Invalid target path format
- Path contains null bytes or reserved characters
- Circular symlink reference attempted

#### C. Implementation Guidelines

**Key Logic:**

```javascript
// In createLink method, enhance error handling (after line ~98)
try {
  await fs.ensureSymlink(sourcePath, targetPath, 'file');
  await this._trackLink(videoId, targetPath);

  return {
    success: true,
    path: targetPath,
    replaced: validation.status !== 'none'
  };
} catch (error) {
  // Existing Windows EPERM handling
  if (error.code === 'EPERM' && process.platform === 'win32') {
    throw new Error(/* existing message */);
  }

  // NEW: Add EINVAL handling
  if (error.code === 'EINVAL') {
    throw new Error(
      `Invalid path for symlink creation (${videoId}).\n` +
      `Source: ${sourcePath}\n` +
      `Target: ${targetPath}\n` +
      'Path may contain unsupported characters, null bytes, or create circular reference.'
    );
  }

  throw new Error(`Symlink creation failed for ${videoId}: ${error.message}`);
}

// In validateTarget method (after line ~193)
if (error.code === 'EACCES' || error.code === 'EPERM') {
  return {
    status: 'permission_denied',
    canProceed: false,
    message: `Permission denied accessing target path: ${targetPath}`
  };
}

// NEW: Add EINVAL handling
if (error.code === 'EINVAL') {
  return {
    status: 'invalid_path',
    canProceed: false,
    message: `Invalid path format: ${targetPath}. May contain unsupported characters.`
  };
}

// In removeLink method (after line ~304)
if (error.code === 'EACCES' || error.code === 'EPERM') {
  throw new Error(`Permission denied removing link: ${linkPath}`);
}

// NEW: Add EINVAL handling
if (error.code === 'EINVAL') {
  throw new Error(
    `Invalid path for link removal: ${linkPath}. ` +
    'Path may contain unsupported characters.'
  );
}
```

**Critical Points:**
- EINVAL during symlink operations often indicates path format issues
- Provide both source and target paths in error for debugging
- Circular symlink detection is OS-level, EINVAL is one indicator
- Maintain existing error handling pattern

#### D. Success Criteria
- [ ] EINVAL handling added to `createLink()` main try-catch
- [ ] EINVAL handling added to `validateTarget()` error handling
- [ ] EINVAL handling added to `removeLink()` error handling
- [ ] Error messages include relevant paths for debugging
- [ ] Cross-platform error messages are clear

#### E. Dependencies & Inputs
- Requires: LinkManager.js (existing file)
- Produces: Better error messages for invalid symlink paths

### Step 3: Verify Cross-Platform Path Validation

#### A. Rationale & Objective
Ensure existing path validation in validators.js and pathResolver.js prevents EINVAL scenarios proactively. Defense in depth: validate before file operations to catch issues early.

#### B. Core Concepts & Strategy
Review and document existing validation:
- `validators.sanitizeVideoId()` - Prevents path traversal in video IDs
- `pathResolver` module - Builds safe paths using path.join()
- Path security in LinkManager and StorageService

Identify any gaps where invalid paths could reach file operations.

#### C. Implementation Guidelines

**Review Checklist:**
1. Video ID validation prevents: `.`, `/`, `\`, null bytes → Already done via regex
2. Path construction uses `path.join()` exclusively → Review all path building
3. No user input directly concatenated to paths → Verify
4. Registry paths always absolute → Verify in LinkManager._trackLink

**Documentation:**

Add comments in key validation points:

```javascript
// In validators.js - Document what sanitizeVideoId prevents
/**
 * Sanitize video ID removing unsafe characters
 * Prevents EINVAL errors by removing:
 * - Path separators (/ \)
 * - Path traversal sequences (..)
 * - Null bytes (\0)
 * - Reserved characters for file systems
 *
 * @param {string} id - Video ID to sanitize
 * @returns {string} Sanitized ID (alphanumeric + dash + underscore only)
 */
function sanitizeVideoId(id) {
  return String(id).replace(/[^A-Za-z0-9_-]/g, '');
}
```

**Critical Points:**
- Video ID regex `[A-Za-z0-9_-]{11}` prevents most EINVAL causes
- All paths constructed via path.join() or path.resolve()
- No direct string concatenation of user input to paths
- Absolute path assertions prevent relative path issues

#### D. Success Criteria
- [ ] Documented all path validation points
- [ ] Verified no user input reaches fs operations unsanitized
- [ ] Confirmed path.join() usage throughout codebase
- [ ] Added defensive EINVAL handlers as last resort

#### E. Dependencies & Inputs
- Requires: Code review of validators.js, pathResolver.js, all services
- Produces: Documentation of validation strategy

### Step 4: Test Error Messages for Actionability

#### A. Rationale & Objective
Ensure all EINVAL error messages guide users to resolution. Error messages should explain what went wrong and suggest corrective actions.

#### B. Core Concepts & Strategy
Review all new error messages:
- Explain the likely cause (invalid characters, length limits)
- Suggest resolution (check video ID format, path lengths)
- Provide context (which operation failed, which file/path)

#### C. Implementation Guidelines

**Error Message Template:**

```javascript
throw new Error(
  `[What failed]: ${operation} failed for ${context}.\n` +
  `[Why it failed]: ${technicalReason}.\n` +
  `[How to fix]: ${userGuidance}`
);
```

**Examples:**

Good:
```javascript
throw new Error(
  `Invalid path for transcript ${videoId}. ` +
  'Path may contain unsupported characters or exceed length limits. ' +
  'Check video ID format and ensure storage path is valid.'
);
```

Bad:
```javascript
throw new Error('EINVAL'); // Not actionable
```

**Critical Points:**
- Include video ID or path in all error messages
- Explain platform-specific constraints when relevant
- Reference documentation or help commands when appropriate
- Maintain consistent tone with existing error messages

#### D. Success Criteria
- [ ] All EINVAL errors include video ID or path context
- [ ] Error messages explain likely cause
- [ ] Error messages suggest resolution steps
- [ ] Messages are concise but complete
- [ ] Cross-platform considerations mentioned where relevant

#### E. Dependencies & Inputs
- Requires: Completed Steps 1-2
- Produces: User-friendly error messages for EINVAL scenarios

## Technical Considerations

### Architecture Impact
- No architectural changes - adding error handling to existing methods
- Maintains separation of concerns (services handle their own errors)
- Follows existing error handling patterns in codebase

### Integration Points
- StorageService error handlers called during file operations
- LinkManager error handlers called during symlink operations
- Error messages propagate to command handlers (process, clean, data)
- All errors logged to console with context

### Risk Mitigation

| Risk | Likelihood | Impact | Mitigation Strategy |
|------|------------|--------|-------------------|
| EINVAL never occurs in practice | Medium | Low | Still worth handling for defensive programming |
| Error messages too verbose | Low | Low | Keep messages concise, test readability |
| Platform-specific EINVAL causes | Medium | Medium | Generic message covers most cases, platform hints added |
| Breaking existing error handling | Low | High | Only adding new cases, not modifying existing |

### Performance Considerations
- Expected load: No performance impact (error paths only)
- Optimization opportunities: None needed
- Monitoring points: Error frequency in logs

## Implementation Notes

### Code Organization

```
src/
├── services/
│   ├── StorageService.js      # Add EINVAL to _handleReadError, _handleDeleteError, _handleExistenceCheckError
│   └── LinkManager.js          # Add EINVAL to createLink, validateTarget, removeLink
└── utils/
    └── validators.js           # Document existing validation (no changes needed)
```

### Coding Standards
- Follow existing error handling pattern: if (error.code === 'EINVAL') { ... }
- Maintain consistent error message format across modules
- Add inline comments explaining when EINVAL typically occurs
- Use multi-line strings for readability (existing pattern)

### Documentation Requirements
- Inline comments explaining EINVAL scenarios
- Update error messages to be self-documenting
- No external documentation needed (error messages are the docs)

## Estimated Effort

| Component | Effort | Complexity |
|-----------|--------|------------|
| StorageService EINVAL handlers | 1 hour | Low |
| LinkManager EINVAL handlers | 1 hour | Low |
| Path validation review | 1 hour | Low |
| Error message refinement | 0.5 hours | Low |
| **Total** | 3.5 hours | Overall: Low |

## Next Steps

1. Begin implementation following Step 1
2. Add EINVAL handling to StorageService error handlers
3. Add EINVAL handling to LinkManager error handlers
4. Review and document path validation strategy
5. Test error messages for clarity and actionability
6. Mark task 8.1.4 as complete in tasks.md

## References

- Technical Requirements: TR-13 (File System Errors)
- Functional Requirements: FR-10 (Failure Recovery)
- Related Tasks: Task 8.1 (File system error handling)
- External Documentation: Node.js fs module error codes (EINVAL typically: invalid argument)
