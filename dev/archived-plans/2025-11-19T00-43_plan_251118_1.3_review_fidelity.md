# Remediation Plan: Architectural Fidelity

**Date:** 2025-11-18
**Task Reference:** 1.3 from @dev/tasks.md
**Status:** Ready for Implementation

## Plan Overview
Correct critical environment configuration path resolution to align with global npm package architecture and remove unnecessary command handler parameters to clean interface contracts.

## High-Level Steps
1. Fix environment loader path resolution to use package directory
2. Clean command handler signatures

## Detailed Breakdown

### Step 1: Fix Environment Loader Path Resolution

#### A. Rationale & Objective
The environment loader currently searches for .env in process.cwd(), violating the globally-installed package architecture. Per project_overview.md line 43, the system must operate "as a globally-installed package accessible from any directory." Current implementation breaks this by requiring .env in user's working directory rather than package installation directory. Addresses Finding 1.

#### B. Recommended Approach & Strategy
The .env file should reside with the package installation (alongside package.json), not in arbitrary user directories. Node.js provides multiple approaches:

1. Use `__dirname` navigation from envLoader.js location
2. Use `require.main.filename` to find entry point
3. Use path resolution from known package structure

Preferred: Navigate from `__dirname` since envLoader.js has known location in package structure (src/utils/). This provides reliable, portable path resolution.

#### C. Implementation Guidelines
```javascript
// In src/utils/envLoader.js, replace lines 20-21

// Current (INCORRECT):
const envPath = path.resolve(process.cwd(), '.env');

// Corrected:
// Navigate from src/utils/ up to package root
const envPath = path.resolve(__dirname, '../../.env');
```

**Key Changes:**
- Change `process.cwd()` to `__dirname` based resolution
- Navigate up two directories from src/utils/ to package root
- Update error message to reflect correct .env location (package installation directory)
- Update help text to clarify .env must be in package directory, not user's working directory

**Validation:**
- After fix, user should be able to run `transcriptor` from any directory
- .env file remains in package installation directory only
- No .env needed in project directories where transcriptor is invoked

### Step 2: Clean Command Handler Signatures

#### A. Rationale & Objective
Command handlers accept unused `options` parameter that serves no documented purpose. Clean interface contracts specify only required parameters. Addresses Finding 2.

#### B. Recommended Approach & Strategy
Review Commander.js documentation to determine if `options` parameter is required by framework convention or can be safely removed. If Commander passes options object regardless, parameter can remain but should be documented. If not framework requirement, remove for cleaner interfaces.

**Investigation Required:**
- Check if Commander.js requires options parameter in action handlers
- Verify if any future command might need access to global options

**Decision Path:**
- If Commander requires: Keep parameter, add JSDoc comment noting it's framework convention
- If Commander does not require: Remove parameter from all command handlers

#### C. Implementation Guidelines
```javascript
// Option A: If Commander requires parameter (add documentation)
/**
 * Process Command Handler
 *
 * Implements FR-8.1: Main command to process youtube.md file
 *
 * @param {Object} options - Commander options object (framework requirement)
 * @returns {Promise<void>}
 */
module.exports = async function processCommand(options) {
  // Implementation
};

// Option B: If Commander does not require (remove parameter)
/**
 * Process Command Handler
 *
 * Implements FR-8.1: Main command to process youtube.md file
 *
 * @returns {Promise<void>}
 */
module.exports = async function processCommand() {
  // Implementation
};

// Apply to:
// - src/commands/process.js
// - src/commands/data.js
// - src/commands/clean.js (retains date parameter)
```

**Files to Update:**
- src/commands/process.js (line 9)
- src/commands/data.js (line 9)
- src/commands/clean.js (line 10, keep date parameter)

## Validation Checklist

- [ ] Environment loader resolves .env from package directory, not cwd
- [ ] Transcriptor executable works from any directory
- [ ] .env location clearly documented in error messages
- [ ] Command handlers have clean, minimal signatures
- [ ] All command handler JSDoc accurately reflects parameters
- [ ] No functional regressions in command routing

## Additional Notes

**Critical Priority:** Step 1 (environment path fix) is critical - current code is architecturally broken for global npm package model.

**Lower Priority:** Step 2 (parameter cleanup) is cosmetic interface improvement.

**Testing Approach:** While project excludes automated tests, manual validation required:
1. Install via `npm link` in package directory
2. Create .env in package directory
3. Navigate to different directory
4. Execute `transcriptor help` to verify it finds .env
5. Verify error messages guide users to correct .env location
